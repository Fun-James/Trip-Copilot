# Trip Copilot 记忆功能集成说明

## 问题描述

由于项目中存在一个前端bug，每次页面刷新或开始新对话时，需要先调用一次前端路径规划才能让地图功能正常工作。在引入记忆功能后，这个问题在开始新对话时也会出现。

## 解决方案

### 1. 增强的记忆功能

现在聊天记录会保存以下完整的状态信息：

- **基础聊天数据**：消息、行程、地图中心
- **行程规划数据**：`currentPlan`（完整的行程规划信息）
- **路径规划数据**：`currentRoute`（当前路径规划结果）
- **UI状态**：`selectedDay`（当前选中的天数）
- **表单状态**：`routeForm`（路径规划表单数据）
- **搜索状态**：`searchQuery`（搜索查询内容）

### 2. 新对话初始化机制

当用户点击"新对话"时，系统会：

1. **保存当前对话**到历史记录
2. **清空所有状态**（消息、行程、路径等）
3. **清空地图数据**（通知地图组件清除所有标记和路径）
4. **重新初始化路径规划**（自动调用津南校区到八里台校区的路径规划）
5. **显示加载状态**（防止用户重复点击）

### 3. 智能上下文聊天

现在AI助手可以感知到：

- 当前的行程规划详情
- 正在查看的天数
- 已规划的路径信息
- 地图状态等

用户可以询问关于行程的任何问题，AI会结合当前状态给出准确回答。

## 主要改进

### 前端改进

1. **`saveCurrentChat()`** - 保存完整的对话状态
2. **`loadChat()`** - 恢复完整的对话状态，包括地图数据
3. **`startNewChat()`** - 异步初始化新对话，包含路径规划初始化
4. **`reinitializeMapRoute()`** - 专门用于重新初始化地图的函数
5. **`handleChatSubmit()`** - 发送结构化上下文给AI
6. **UI增强** - 新对话按钮loading状态，聊天输入框等

### 后端改进

1. **增强的聊天API** - 可以解析结构化的上下文信息
2. **智能上下文处理** - 将行程、路径、地图状态转换为可读描述
3. **更好的AI提示词** - 让AI理解地图和行程规划功能

## 使用说明

### 开始新对话
1. 点击左侧边栏的"新对话"按钮
2. 等待初始化完成（按钮会显示"初始化中..."）
3. 开始输入目的地进行行程规划

### 聊天功能
1. 在左侧面板底部的聊天框中输入问题
2. AI会结合当前的行程和地图状态回答
3. 支持询问具体景点、路径、交通等问题

### 历史对话
1. 所有对话都会自动保存到左侧边栏
2. 点击任意历史对话可以完整恢复状态
3. 包括行程规划、地图标记、路径等

## 技术细节

### 状态保存格式
```javascript
{
  messages: [...],              // 聊天消息
  currentPlan: {...},           // 行程规划数据
  currentRoute: {...},          // 路径规划数据
  selectedDay: 1,               // 当前选中天数
  routeForm: {...},             // 路径表单状态
  searchQuery: "...",           // 搜索查询
  mapCenter: {lng, lat},        // 地图中心
  itinerary: [...],             // 行程数据（兼容旧版）
  lastUpdated: timestamp,       // 最后更新时间
  title: "..."                  // 对话标题
}
```

### AI上下文格式
```javascript
{
  currentPlan: {
    destination: "目的地",
    total_days: 3,
    itinerary: [
      {day: 1, theme: "主题", places: [...]},
      ...
    ]
  },
  currentRoute: {
    start_point: {name: "起点"},
    end_point: {name: "终点"},
    mode: "driving"
  },
  selectedDay: 1,
  ...
}
```

## 注意事项

1. **地图初始化**：新对话时会自动调用路径规划来初始化地图状态
2. **静默操作**：自动初始化过程不会显示成功提示，只在控制台输出日志
3. **错误处理**：如果初始化失败，不会影响其他功能的使用
4. **性能优化**：使用深拷贝确保状态隔离，避免引用问题

## 已解决的问题

✅ 开始新对话时地图功能正常工作  
✅ 完整的状态记忆和恢复  
✅ AI可以感知当前行程和地图状态  
✅ 用户体验优化（loading状态、错误处理）  
✅ 兼容性保持（支持旧版聊天记录）

这次改进确保了无论用户如何使用系统（页面刷新、新对话、历史对话切换），地图功能都能正常工作，同时AI助手也能提供更加智能和准确的回答。
